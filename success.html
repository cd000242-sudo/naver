<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ í™•ì¸ ì¤‘... â€” Better Life</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css"
        rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>

<body>
    <div class="bg-pattern"></div>

    <div class="container">
        <header class="page-header">
            <div class="brand-badge">
                <span class="dot"></span>
                Better Life
            </div>
        </header>

        <div class="code-container">
            <!-- Phase 1: ë¡œë”© -->
            <div id="loading-section" class="loading-section">
                <div class="loading-spinner-lg"></div>
                <div class="loading-text">ê²°ì œë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
                <div class="loading-subtext">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”... ì½”ë“œê°€ ê³· ë°œê¸‰ë©ë‹ˆë‹¤.</div>
            </div>

            <!-- Phase 2a: ì½”ë“œ í‘œì‹œ (ì„±ê³µ) -->
            <div id="code-section" class="hidden">
                <div class="code-card">
                    <div class="success-icon">âœ“</div>
                    <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 4px;">ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                    <p id="product-name" style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 28px;">
                    </p>

                    <div class="code-label">ë¼ì´ì„ ìŠ¤ ì½”ë“œ</div>
                    <div class="code-display" id="license-code"></div>

                    <button class="btn-copy" id="btn-copy" onclick="copyCode()">
                        ğŸ“‹ ì½”ë“œ ë³µì‚¬í•˜ê¸°
                    </button>

                    <div
                        style="background: rgba(68, 215, 182, 0.06); border: 1px solid rgba(68, 215, 182, 0.15); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 24px;">
                        <p style="font-size: 0.85rem; color: var(--success); font-weight: 600; margin-bottom: 6px;">ğŸ’¡
                            ì‚¬ìš© ë°©ë²•</p>
                        <p style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6;">
                            Better Life ì•±ì„ ì‹¤í–‰í•˜ê³  ë¼ì´ì„ ìŠ¤ ë“±ë¡ í™”ë©´ì—ì„œ<br>
                            ìœ„ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- ì´ë©”ì¼ ë°±ì—… -->
                    <div class="email-backup">
                        <div class="email-backup-label">ğŸ“§ ì´ë©”ì¼ë¡œ ì½”ë“œ ë°±ì—… ë°›ê¸° (ì„ íƒ)</div>
                        <div class="email-input-group">
                            <input type="email" class="email-input" id="backup-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥">
                            <button class="btn-send-email" id="btn-send-email" onclick="sendBackupEmail()">ë°œì†¡</button>
                        </div>
                        <div class="email-status" id="email-status"></div>
                    </div>
                </div>
            </div>

            <!-- Phase 2b: ì—ëŸ¬/íƒ€ì„ì•„ì›ƒ -->
            <div id="error-section" class="hidden">
                <div class="error-card">
                    <div class="error-icon">âš ï¸</div>
                    <div class="error-title" id="error-title">ê²°ì œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                    <div class="error-message" id="error-message"></div>
                    <button class="btn-retry" id="btn-check-order" onclick="checkOrder()" style="margin-bottom: 12px;">
                        ğŸ” ì£¼ë¬¸ í™•ì¸í•˜ê¸°
                    </button>
                    <br>
                    <a href="index.html" class="btn-retry"
                        style="background: var(--bg-glass); border: 1px solid var(--border-glass); font-size: 0.9rem; padding: 12px 24px;">
                        â† ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                    <p style="margin-top: 16px; font-size: 0.8rem; color: var(--text-muted);">
                        ë¬¸ì˜: <a href="mailto:cd000242@gmail.com"
                            style="color: var(--accent-secondary);">cd000242@gmail.com</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="page-footer">
            <p>Â© 2026 Better Life. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // ===== ì„¤ì • =====
        const CONFIG = {
            // â˜… GAS ì›¹ì•± URL (ë°°í¬ í›„ êµì²´ í•„ìš”)
            GAS_URL: 'https://script.google.com/macros/s/AKfycbxBOGkjVj4p-6XZ4SEFYKhW3FBmo5gt7Fv6djWhB1TljnDDmx_qlfZ4YdlJNohzIZ8NJw/exec',
            TIMEOUT_MS: 20000, // 20ì´ˆ íƒ€ì„ì•„ì›ƒ
        };

        let currentCode = null;
        let currentProduct = null;
        let currentOrderId = null;

        // ===== URL íŒŒë¼ë¯¸í„° íŒŒì‹± =====
        function getParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                paymentKey: params.get('paymentKey'),
                orderId: params.get('orderId'),
                amount: params.get('amount'),
            };
        }

        // ===== JSONP í˜¸ì¶œ =====
        function callGASviaJSONP(params) {
            return new Promise((resolve, reject) => {
                // íƒ€ì„ì•„ì›ƒ ì„¤ì •
                const timeoutId = setTimeout(() => {
                    cleanup();
                    reject(new Error('TIMEOUT'));
                }, CONFIG.TIMEOUT_MS);

                // ê³ ìœ  ì½œë°±ëª…
                const callbackName = '__tossCallback_' + Date.now();

                // ì „ì—­ ì½œë°± ë“±ë¡
                window[callbackName] = function (data) {
                    clearTimeout(timeoutId);
                    cleanup();
                    resolve(data);
                };

                // ì •ë¦¬ í•¨ìˆ˜
                function cleanup() {
                    delete window[callbackName];
                    const script = document.getElementById('jsonp-script');
                    if (script) script.remove();
                }

                // JSONP script íƒœê·¸ ìƒì„±
                const script = document.createElement('script');
                script.id = 'jsonp-script';
                script.src = `${CONFIG.GAS_URL}?action=confirm-payment` +
                    `&paymentKey=${encodeURIComponent(params.paymentKey)}` +
                    `&orderId=${encodeURIComponent(params.orderId)}` +
                    `&amount=${encodeURIComponent(params.amount)}` +
                    `&callback=${callbackName}`;

                script.onerror = function () {
                    clearTimeout(timeoutId);
                    cleanup();
                    reject(new Error('NETWORK_ERROR'));
                };

                document.head.appendChild(script);
            });
        }

        // ===== ì½”ë“œ í‘œì‹œ =====
        function showCode(code, product) {
            currentCode = code;
            currentProduct = product;

            document.getElementById('license-code').textContent = code;
            document.getElementById('product-name').textContent = product;

            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('code-section').classList.remove('hidden');

            // í˜ì´ì§€ íƒ€ì´í‹€ ë³€ê²½
            document.title = 'ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ì™„ë£Œ â€” Better Life';
        }

        // ===== ì—ëŸ¬ í‘œì‹œ =====
        function showError(message, title) {
            document.getElementById('error-title').textContent = title || 'ê²°ì œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
            document.getElementById('error-message').textContent = message;

            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('code-section').classList.add('hidden');
            document.getElementById('error-section').classList.remove('hidden');
        }

        // ===== ì½”ë“œ ë³µì‚¬ =====
        async function copyCode() {
            if (!currentCode) return;
            try {
                await navigator.clipboard.writeText(currentCode);
                const btn = document.getElementById('btn-copy');
                btn.classList.add('copied');
                btn.innerHTML = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = 'ğŸ“‹ ì½”ë“œ ë³µì‚¬í•˜ê¸°';
                }, 2000);
            } catch (err) {
                // fallback
                const textarea = document.createElement('textarea');
                textarea.value = currentCode;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                const btn = document.getElementById('btn-copy');
                btn.classList.add('copied');
                btn.innerHTML = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = 'ğŸ“‹ ì½”ë“œ ë³µì‚¬í•˜ê¸°';
                }, 2000);
            }
        }

        // ===== ì´ë©”ì¼ ë°±ì—… ë°œì†¡ =====
        async function sendBackupEmail() {
            const emailInput = document.getElementById('backup-email');
            const btn = document.getElementById('btn-send-email');
            const status = document.getElementById('email-status');
            const email = emailInput.value.trim();

            if (!email || !email.includes('@')) {
                status.textContent = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                status.style.color = 'var(--error)';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ë°œì†¡ ì¤‘...';
            status.textContent = '';

            try {
                // GASì— ì´ë©”ì¼ ë°œì†¡ ìš”ì²­ (JSONP)
                const callbackName = '__emailCallback_' + Date.now();

                await new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('TIMEOUT'));
                    }, 15000);

                    window[callbackName] = function (data) {
                        clearTimeout(timeoutId);
                        delete window[callbackName];
                        resolve(data);
                    };

                    const script = document.createElement('script');
                    script.src = `${CONFIG.GAS_URL}?action=send-code-email` +
                        `&email=${encodeURIComponent(email)}` +
                        `&code=${encodeURIComponent(currentCode)}` +
                        `&product=${encodeURIComponent(currentProduct)}` +
                        `&callback=${callbackName}`;
                    script.onerror = () => {
                        clearTimeout(timeoutId);
                        delete window[callbackName];
                        reject(new Error('NETWORK'));
                    };
                    document.head.appendChild(script);
                });

                btn.classList.add('sent');
                btn.textContent = 'ë°œì†¡ ì™„ë£Œ âœ“';
                status.textContent = `${email}ë¡œ ì½”ë“œê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                status.style.color = 'var(--success)';
            } catch (err) {
                btn.disabled = false;
                btn.textContent = 'ë°œì†¡';
                status.textContent = 'ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                status.style.color = 'var(--error)';
            }
        }

        // ===== ì£¼ë¬¸ í™•ì¸ (íƒ€ì„ì•„ì›ƒ ë³µêµ¬) =====
        async function checkOrder() {
            if (!currentOrderId) {
                showError('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'ì£¼ë¬¸ í™•ì¸ ì‹¤íŒ¨');
                return;
            }

            // ë¡œë”© ìƒíƒœë¡œ ì „í™˜
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('loading-section').classList.remove('hidden');
            document.querySelector('.loading-text').textContent = 'ì£¼ë¬¸ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

            try {
                const callbackName = '__checkCallback_' + Date.now();

                const result = await new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('TIMEOUT'));
                    }, 15000);

                    window[callbackName] = function (data) {
                        clearTimeout(timeoutId);
                        delete window[callbackName];
                        resolve(data);
                    };

                    const script = document.createElement('script');
                    script.src = `${CONFIG.GAS_URL}?action=check-order` +
                        `&orderId=${encodeURIComponent(currentOrderId)}` +
                        `&callback=${callbackName}`;
                    script.onerror = () => {
                        clearTimeout(timeoutId);
                        delete window[callbackName];
                        reject(new Error('NETWORK'));
                    };
                    document.head.appendChild(script);
                });

                if (result.ok && result.code) {
                    showCode(result.code, result.product);
                } else {
                    showError(result.error || 'ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³ ê° ì§€ì›ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'ì£¼ë¬¸ í™•ì¸ ì‹¤íŒ¨');
                }
            } catch (err) {
                showError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ì—°ê²° ì‹¤íŒ¨');
            }
        }

        // ===== ë©”ì¸ ì‹¤í–‰ =====
        async function main() {
            const params = getParams();

            // íŒŒë¼ë¯¸í„° ê²€ì¦
            if (!params.paymentKey || !params.orderId || !params.amount) {
                showError('ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ì˜ëª»ëœ ì ‘ê·¼');
                document.getElementById('btn-check-order').style.display = 'none';
                return;
            }

            currentOrderId = params.orderId;

            try {
                // JSONPë¡œ GAS ê²°ì œ ìŠ¹ì¸ ìš”ì²­
                const result = await callGASviaJSONP(params);

                if (result.ok && result.code) {
                    showCode(result.code, result.product);
                } else {
                    showError(result.error || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ê²°ì œ í™•ì¸ ì‹¤íŒ¨');
                }
            } catch (err) {
                if (err.message === 'TIMEOUT') {
                    showError(
                        'ì„œë²„ ì‘ë‹µì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ê²°ì œëŠ” ì •ìƒ ì²˜ë¦¬ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ë¬¸ì„ í™•ì¸í•´ë³´ì„¸ìš”.',
                        'ì‘ë‹µ ì§€ì—°'
                    );
                } else {
                    showError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ë¬¸ì„ í™•ì¸í•´ë³´ì„¸ìš”.', 'ì—°ê²° ì‹¤íŒ¨');
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>

</html>